<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1a2452" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Time Table" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>Time Table Â· è¯¾ç¨‹/æ—¥ç¨‹ç®¡ç†</title>
  <style>
    :root{--bg:#0f1220;--card:rgba(255,255,255,.08);--text:#eaf0ff;--muted:#b8c3e8;--primary:#6ea8ff;--accent:#9a7bff;--danger:#ff6f8e}
    *{box-sizing:border-box}
    body{margin:0;padding:20px;font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;color:var(--text);background:radial-gradient(1200px 800px at -10% -20%, #2b3f7f 0%, transparent 60%),radial-gradient(900px 700px at 120% 120%, #4a2c8a 0%, transparent 55%),var(--bg)}
    .container{max-width:1320px;margin:0 auto;display:grid;grid-template-columns:220px 1fr;gap:14px}
    .container.roles-collapsed{grid-template-columns:68px 1fr}
    .panel{background:var(--card);border:1px solid rgba(255,255,255,.15);border-radius:14px;backdrop-filter:blur(8px)}
    .roles{padding:14px;position:sticky;top:12px;height:fit-content}
    .roles h3{margin:0 0 10px}
    .roles-head{display:flex;justify-content:space-between;align-items:center;gap:6px}
    .container.roles-collapsed .roles{padding:10px 8px}
    .container.roles-collapsed .roles h3,.container.roles-collapsed #addRoleBtn,.container.roles-collapsed #openEditorBtn{display:none}
    .container.roles-collapsed .role-btn{padding:8px 4px;text-align:center}
    .role-buttons{display:grid;gap:8px}
    .role-item{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center}
    .role-btn{border:1px solid rgba(255,255,255,.22);background:rgba(255,255,255,.08);color:#fff;padding:8px 10px;border-radius:10px;text-align:left;cursor:pointer}
    .role-btn.active{background:linear-gradient(135deg,var(--primary),var(--accent));border-color:transparent}
    .role-mini{padding:8px 9px;border-radius:10px;background:rgba(255,255,255,.12)}
    .board{padding:12px}
    .toolbar{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .left,.right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .inline-group{display:flex;gap:8px;align-items:center;flex-wrap:nowrap}
    #filterDay{width:auto;min-width:108px;max-width:130px}
    .chip{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.15)}
    button,input,select,textarea{font:inherit}
    button{border:0;padding:9px 10px;border-radius:10px;color:#fff;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent))}
    .btn-ghost{background:rgba(255,255,255,.12)}
    .btn-danger{background:linear-gradient(135deg,#ff5f7b,#ff7f5f)}
    .muted{color:var(--muted);font-size:12px}
    .table-wrap{overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.15);margin-top:8px}
    .hidden{display:none!important}
    table{width:100%;min-width:980px;border-collapse:collapse;background:rgba(8,10,20,.4)}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:14px;text-align:left}
    th{background:rgba(255,255,255,.08)}
    .pill{padding:4px 8px;border:1px solid rgba(255,255,255,.2);border-radius:999px;font-size:12px}
    .actions{display:flex;gap:6px}.actions button{padding:6px 9px;font-size:12px}
    .cards-wrap{margin-top:8px;border-radius:12px;border:1px solid rgba(255,255,255,.15);padding:10px;overflow:auto}
    .cards-grid{display:grid;grid-template-columns:repeat(7,minmax(170px,1fr));gap:10px;min-width:980px}
    .day-col{border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:8px;background:rgba(255,255,255,.06)}
    .day-col h3{margin:0 0 8px;font-size:14px;display:flex;justify-content:space-between}
    .day-list{display:grid;gap:8px;align-content:start}
    .tt-card{border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:9px;background:linear-gradient(160deg, rgba(255,255,255,.12), rgba(255,255,255,.06));min-height:218px;display:grid;grid-template-rows:44px 38px 18px 18px 18px auto auto}
    .icon{font-size:40px;line-height:1}.title{font-size:15px;font-weight:700;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
    .meta{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card-actions{display:flex;gap:6px;align-self:end}.card-actions button{padding:6px 9px;font-size:12px}
    .empty{text-align:center;padding:20px;color:var(--muted)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:30}
    .modal.show{display:flex}
    .modal-card{width:min(640px,100%);background:rgba(20,24,44,.96);border:1px solid rgba(255,255,255,.2);border-radius:14px;padding:14px}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px}
    input,select,textarea{width:100%;padding:9px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(10,12,24,.45);color:var(--text)}
    textarea{min-height:62px}
    .btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}

    @media (max-width:980px){.container{grid-template-columns:1fr} body{padding:12px}}
  </style>
</head>
<body>
<div class="container">
  <aside class="panel roles">
    <div class="roles-head">
      <h3>ğŸ‘¥ è§’è‰²</h3>
      <button class="btn-ghost" id="toggleRolesBtn" type="button">æ”¶èµ·</button>
    </div>
    <div id="roleButtons" class="role-buttons"></div>
    <button class="btn-ghost" id="addRoleBtn" type="button" style="margin-top:10px;width:100%">+ æ–°å¢è§’è‰²</button>
    <div class="muted" style="margin-top:8px;text-align:center;">&nbsp;</div>
  </aside>

  <main class="panel board">
    <div class="toolbar">
      <div class="left">
        <span class="chip" id="countChip">å…± 0 æ¡</span>
        <span class="chip" id="roleChip">å½“å‰è§’è‰²ï¼š-</span>
        <div class="inline-group">
          <select id="filterDay"><option value="å…¨éƒ¨">å…¨éƒ¨æ˜ŸæœŸ</option><option>å‘¨ä¸€</option><option>å‘¨äºŒ</option><option>å‘¨ä¸‰</option><option>å‘¨å››</option><option>å‘¨äº”</option><option>å‘¨å…­</option><option>å‘¨æ—¥</option></select>
          <button class="btn-primary" id="openEditorBtn" type="button">+ æ–°å»ºè¯¾ç¨‹</button>
        </div>
      </div>
      <div class="right">
        <button class="btn-ghost" id="copyPrevDayBtn" type="button">å¤åˆ¶å‰ä¸€å¤©</button>
        <button class="btn-ghost" id="toggleViewBtn" type="button">åˆ‡æ¢åˆ°è¡¨æ ¼æ¨¡å¼</button>
        <button class="btn-ghost" id="exportImageBtn" type="button">å¯¼å‡ºå›¾ç‰‡</button>
        <button class="btn-ghost" id="shareImageBtn" type="button">åˆ†äº«å›¾ç‰‡</button>
        <button class="btn-ghost" id="exportCsvBtn" type="button">å¯¼å‡º CSV</button>
        <button class="btn-ghost" id="exportExcelBtn" type="button">å¯¼å‡º Excel</button>
        <button class="btn-ghost" id="backupGithubBtn" type="button">å¤‡ä»½åˆ° GitHub</button>
        <button class="btn-ghost" id="forceRefreshBtn" type="button">åŒæ­¥æ•°æ®</button>
        <button class="btn-ghost" id="restoreGithubBtn" type="button">æ¢å¤æœ€è¿‘å¤‡ä»½</button>
      </div>
    </div>

    <div class="muted">æç¤ºï¼šç¼–è¾‘é¡µé¢ä¸ºå¼¹çª—ã€‚æ¯èŠ‚è¯¾å¯ç‹¬ç«‹è®¾ç½®â€œè¯¾å‰5åˆ†é’Ÿé—¹é“ƒâ€ã€‚</div>

    <div id="tableWrap" class="table-wrap hidden"><table><thead><tr><th>æ˜ŸæœŸ</th><th>æ—¶é—´</th><th>å›¾æ ‡</th><th>äº‹é¡¹</th><th>ç±»å‹</th><th>åœ°ç‚¹</th><th>å¤‡æ³¨</th><th>é—¹é“ƒ</th><th>æ“ä½œ</th></tr></thead><tbody id="tbody"></tbody></table></div>
    <div id="cardsWrap" class="cards-wrap"><div id="cardsGrid" class="cards-grid"></div></div>
    <div id="empty" class="empty">è¿˜æ²¡æœ‰å®‰æ’ï¼Œå…ˆç‚¹ä¸Šæ–¹â€œæ–°å»ºè¯¾ç¨‹â€å§ âœ¨</div>
  </main>
</div>

<div id="editorModal" class="modal">
  <div class="modal-card">
    <div class="modal-head">
      <h3 style="margin:0">ğŸ“ ç¼–è¾‘è¯¾ç¨‹</h3>
      <button class="btn-ghost" id="closeEditorBtn" type="button">å…³é—­</button>
    </div>
    <form id="entryForm">
      <input type="hidden" id="entryId" />
      <label>è¯¾ç¨‹ / äº‹é¡¹</label><input id="title" required placeholder="ä¾‹å¦‚ï¼šæ•°å­¦ / é¡¹ç›®æ™¨ä¼š" />
      <div class="row">
        <div><label>æ˜ŸæœŸ</label><select id="day"><option>å‘¨ä¸€</option><option>å‘¨äºŒ</option><option>å‘¨ä¸‰</option><option>å‘¨å››</option><option>å‘¨äº”</option><option>å‘¨å…­</option><option>å‘¨æ—¥</option></select></div>
        <div><label>ç±»å‹</label><select id="type"><option>è¯¾ç¨‹</option><option>ä¼šè®®</option><option>å­¦ä¹ </option><option>é”»ç‚¼</option><option>éŸ³ä¹</option><option>èˆè¹ˆ</option><option>å…¶ä»–</option></select></div>
      </div>
      <div class="row"><div><label>å¼€å§‹æ—¶é—´</label><input id="start" type="time" required /></div><div><label>ç»“æŸæ—¶é—´</label><input id="end" type="time" required /></div></div>
      <label>åœ°ç‚¹</label><input id="location" placeholder="ä¾‹å¦‚ï¼šA-302 / Zoom" />
      <label>å¤‡æ³¨</label><textarea id="note" placeholder="å¯é€‰"></textarea>
      <label style="display:flex;align-items:center;gap:8px;margin-top:10px;"><input id="alarmOn" type="checkbox" style="width:auto;"> å¼€å¯é—¹é“ƒï¼ˆè¯¾å‰5åˆ†é’Ÿï¼‰</label>
      <div class="btn-row"><button class="btn-primary" id="saveBtn" type="submit">ä¿å­˜</button><button class="btn-ghost" type="button" id="resetBtn">æ¸…ç©º</button></div>
    </form>
  </div>
</div>

<script>
const STORAGE_KEY='pretty_timetable_v1';
const ROLE_LIST_KEY='timetable_roles_v1';
const ROLE_ACTIVE_KEY='timetable_role_active_v1';
const ROLE_MIGRATED_KEY='timetable_roles_migrated_v1';
const GITHUB_CFG_KEY='timetable_github_cfg_v1';
const ROLES_COLLAPSED_KEY='timetable_roles_collapsed_v1';
const ALARM_FIRED_KEY='timetable_alarm_fired_v1';
const dayOrder=['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'];
const typeIcons={è¯¾ç¨‹:'ğŸ“˜',ä¼šè®®:'ğŸ§‘â€ğŸ’¼',å­¦ä¹ :'ğŸ§ ',é”»ç‚¼:'ğŸƒ',éŸ³ä¹:'ğŸµ',èˆè¹ˆ:'ğŸ’ƒ',å…¶ä»–:'ğŸ—‚ï¸'};
const $=id=>document.getElementById(id);
let currentRole='Jackson';
let list=[];
let viewMode='card';

function roleStorageKey(role){ return `${STORAGE_KEY}__${role}`; }
function getRoles(){ try{ const r=JSON.parse(localStorage.getItem(ROLE_LIST_KEY)||'[]'); return Array.isArray(r)?r:[]; }catch{return[]} }
function setRoles(roles){ localStorage.setItem(ROLE_LIST_KEY, JSON.stringify([...new Set(roles)])); }
function loadRole(role){ try{return JSON.parse(localStorage.getItem(roleStorageKey(role))||'[]')}catch{return[]} }
function persist(){ localStorage.setItem(roleStorageKey(currentRole), JSON.stringify(list)); }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function esc(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
function sortList(arr){ return [...arr].sort((a,b)=>{ const d=dayOrder.indexOf(a.day)-dayOrder.indexOf(b.day); return d||a.start.localeCompare(b.start); }); }
function alarmEnabled(item){ const v=item?.alarmOn; return !(v===false||v===0||v==='0'||v==='false'||v==='å…³'||v==='off'||v==='OFF'); }
function getFiredMap(){ try{return JSON.parse(localStorage.getItem(ALARM_FIRED_KEY)||'{}')}catch{return{}} }
function setFiredMap(m){ localStorage.setItem(ALARM_FIRED_KEY, JSON.stringify(m)); }

function migrateToJackson(){
  if(localStorage.getItem(ROLE_MIGRATED_KEY)==='1') return;
  let roles=getRoles();
  if(!roles.length){ roles=['Jackson']; setRoles(roles); }
  if(!roles.includes('Jackson')){ roles.push('Jackson'); setRoles(roles); }
  const jackson=loadRole('Jackson');
  if(!jackson.length){
    const legacy=(()=>{try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]}})();
    if(Array.isArray(legacy)&&legacy.length) localStorage.setItem(roleStorageKey('Jackson'), JSON.stringify(legacy));
    else for(const r of roles){ const d=loadRole(r); if(d.length){ localStorage.setItem(roleStorageKey('Jackson'), JSON.stringify(d)); break; } }
  }
  localStorage.setItem(ROLE_MIGRATED_KEY,'1');
}
function closeAllExistingAlarms(){
  const roles=getRoles();
  for(const r of roles){
    const d=loadRole(r);
    if(!Array.isArray(d)||!d.length) continue;
    let changed=false;
    const next=d.map(it=>{
      if(it.alarmOn===false) return it;
      changed=true;
      return {...it, alarmOn:false};
    });
    if(changed) localStorage.setItem(roleStorageKey(r), JSON.stringify(next));
  }
}

function applyRolesCollapsed(v){
  const c=document.querySelector('.container');
  c.classList.toggle('roles-collapsed', !!v);
  $('toggleRolesBtn').textContent = v ? 'å±•å¼€' : 'æ”¶èµ·';
  localStorage.setItem(ROLES_COLLAPSED_KEY, v ? '1' : '0');
}
function renderRoles(){
  const roles=getRoles();
  const collapsed=document.querySelector('.container').classList.contains('roles-collapsed');
  $('roleButtons').innerHTML=roles.map(r=>`<div class="role-item"><button class="role-btn ${r===currentRole?'active':''}" data-action="switch" data-role="${esc(r)}" title="${esc(r)}">${collapsed?esc(r).slice(0,1):esc(r)}</button><button class="role-mini" data-action="rename" data-role="${esc(r)}" title="é‡å‘½å">âœï¸</button><button class="role-mini" data-action="delete" data-role="${esc(r)}" title="åˆ é™¤">ğŸ—‘ï¸</button></div>`).join('');
  $('roleChip').textContent=`å½“å‰è§’è‰²ï¼š${currentRole}`;
}
function switchRole(role){
  currentRole=role; localStorage.setItem(ROLE_ACTIVE_KEY, role);
  list=loadRole(role); renderRoles(); render();
  pullLatestForRole(true);
}

function openEditor(){ $('editorModal').classList.add('show'); }
function closeEditor(){ $('editorModal').classList.remove('show'); }
function clearForm(){ $('entryId').value=''; $('entryForm').reset(); $('saveBtn').textContent='ä¿å­˜'; $('day').value='å‘¨ä¸€'; $('type').value='è¯¾ç¨‹'; $('alarmOn').checked=false; }
function fillForm(it){ $('entryId').value=it.id||''; ['title','day','type','start','end','location','note'].forEach(k=>$(k).value=it[k]||''); $('alarmOn').checked=alarmEnabled(it); $('saveBtn').textContent='ä¿å­˜ä¿®æ”¹'; openEditor(); }

function render(){
  const fd=$('filterDay').value;
  const view=sortList(list).filter(i=>fd==='å…¨éƒ¨'||i.day===fd);
  $('tbody').innerHTML=''; $('cardsGrid').innerHTML='';
  $('empty').style.display=view.length?'none':'block';
  $('countChip').textContent=`å…± ${view.length} æ¡`;

  for(const it of view){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.day}</td><td><span class="pill">${it.start} - ${it.end}</span></td><td style="font-size:20px">${typeIcons[it.type]||'ğŸ“Œ'}</td><td>${esc(it.title)}</td><td>${esc(it.type)}</td><td>${esc(it.location||'-')}</td><td>${esc(it.note||'-')}</td><td>${alarmEnabled(it)?'å¼€':'å…³'}</td><td><div class="actions"><button class="btn-ghost" data-action="edit" data-id="${it.id}">ç¼–è¾‘</button><button class="btn-danger" data-action="delete" data-id="${it.id}">åˆ é™¤</button></div></td>`;
    $('tbody').appendChild(tr);
  }

  const days=fd==='å…¨éƒ¨'?dayOrder:[fd];
  for(const day of days){
    const items=view.filter(x=>x.day===day);
    const col=document.createElement('div'); col.className='day-col';
    col.innerHTML=`<h3>${day}<span class="muted">${items.length} æ¡</span></h3><div class="day-list">${items.length?items.map(it=>`<div class="tt-card"><div class="icon">${typeIcons[it.type]||'ğŸ“Œ'}</div><div class="title">${esc(it.title)}</div><div class="meta">${esc(it.start)} - ${esc(it.end)}</div><div class="meta">${esc(it.type)} Â· ${esc(it.location||'-')}</div><div class="meta">é—¹é“ƒï¼š${alarmEnabled(it)?'å¼€':'å…³'}</div><div class="meta">${esc(it.note||'-')}</div><div class="card-actions"><button class="btn-ghost" data-action="edit" data-id="${it.id}">ç¼–è¾‘</button><button class="btn-danger" data-action="delete" data-id="${it.id}">åˆ é™¤</button></div></div>`).join(''):'<div class="muted">æš‚æ— è¯¾ç¨‹</div>'}</div>`;
    $('cardsGrid').appendChild(col);
  }
}

function syncViewMode(){
  $('tableWrap').classList.toggle('hidden', viewMode!=='table');
  $('cardsWrap').classList.toggle('hidden', viewMode!=='card');
  $('toggleViewBtn').textContent=viewMode==='card'?'åˆ‡æ¢åˆ°è¡¨æ ¼æ¨¡å¼':'åˆ‡æ¢åˆ°å¡ç‰‡æ¨¡å¼';
}

function getNextOccurrence(item, now=new Date()){
  const dayMap={'å‘¨æ—¥':0,'å‘¨ä¸€':1,'å‘¨äºŒ':2,'å‘¨ä¸‰':3,'å‘¨å››':4,'å‘¨äº”':5,'å‘¨å…­':6};
  const [hh,mm]=(item.start||'00:00').split(':').map(Number);
  const target=dayMap[item.day]; if(target===undefined) return null;
  const d=new Date(now); d.setHours(hh||0,mm||0,0,0);
  const ahead=(target-now.getDay()+7)%7; d.setDate(now.getDate()+ahead);
  if(d.getTime()-5*60000<=now.getTime()) d.setDate(d.getDate()+7);
  return d;
}
function alarmTick(){
  if(!Array.isArray(list)||!list.length) return;
  const now=new Date(); const fired=getFiredMap(); let changed=false;
  for(const item of list){
    if(!alarmEnabled(item)) continue;
    const start=getNextOccurrence(item, now); if(!start) continue;
    const remindAt=start.getTime()-5*60000;
    const key=`${currentRole}_${item.id}_${start.toISOString().slice(0,10)}_${item.start}`;
    // å®¹é”™çª—å£ï¼šå³ä½¿é¡µé¢åˆšè¢«å”¤é†’ï¼Œä¹Ÿå…è®¸åœ¨å¼€è¯¾å10åˆ†é’Ÿå†…è¡¥å‘æé†’
    if(now.getTime()>=remindAt && now.getTime()<=start.getTime()+10*60000 && !fired[key]){
      const msg=`[${currentRole}] ${item.title} ${item.day} ${item.start} å³å°†å¼€å§‹/å·²å¼€å§‹ï¼Œè¯·ç•™æ„`;
      if('Notification' in window && Notification.permission==='granted') new Notification('è¯¾ç¨‹æé†’', { body: msg });
      else alert(`ğŸ”” ${msg}`);
      fired[key]=Date.now(); changed=true;
    }
  }
  if(changed) setFiredMap(fired);
}

function getGithubCfg(){ try{return JSON.parse(localStorage.getItem(GITHUB_CFG_KEY)||'{}')}catch{return{}} }
function setGithubCfg(cfg){ localStorage.setItem(GITHUB_CFG_KEY,JSON.stringify(cfg)); }
function readGithubCfg(force=false){
  const old=getGithubCfg();
  if(!force && old.owner&&old.repo&&old.branch&&old.token) return old;
  const owner=prompt('GitHub Ownerï¼ˆç”¨æˆ·åï¼‰', old.owner||'jasonyangaccela'); if(owner===null) return null;
  const repo=prompt('GitHub Repoï¼ˆä»“åº“åï¼‰', old.repo||'timetable'); if(repo===null) return null;
  const branch=prompt('Branchï¼ˆåˆ†æ”¯ï¼‰', old.branch||'main'); if(branch===null) return null;
  const token=prompt('GitHub PATï¼ˆ401æ—¶è¯·é‡æ–°ç²˜è´´ï¼‰', ''); if(!token) return null;
  const cfg={owner:owner.trim(),repo:repo.trim(),branch:branch.trim(),token:token.trim()}; setGithubCfg(cfg); return cfg;
}
function getPublicRepoCfg(){
  const old=getGithubCfg();
  return {
    owner:(old.owner||'jasonyangaccela').trim(),
    repo:(old.repo||'timetable').trim(),
    branch:(old.branch||'main').trim()
  };
}
async function pullLatestForRole(silent=true){
  const cfg=getPublicRepoCfg();
  const roleUrls=[
    `https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/${cfg.branch}/backups/${encodeURIComponent(currentRole)}-latest.json?v=${Date.now()}`,
    `https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/${cfg.branch}/data-${encodeURIComponent(currentRole)}.json?v=${Date.now()}`
  ];
  try{
    let d=null;
    for(const url of roleUrls){
      const r=await fetch(url,{cache:'no-store'});
      if(!r.ok) continue;
      const j=await r.json();
      if(Array.isArray(j)){ d=j; break; }
    }

    // ä»… Jackson å…è®¸ç”¨é€šç”¨ data.json å…œåº•ï¼Œé¿å…æŠŠä¸€ä¸ªäººçš„æ•°æ®çŒåˆ°å…¶ä»–è§’è‰²
    if(!d && currentRole==='Jackson'){
      const r=await fetch(`https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/${cfg.branch}/data.json?v=${Date.now()}`,{cache:'no-store'});
      if(r.ok){ const j=await r.json(); if(Array.isArray(j)) d=j; }
    }

    if(!d) return;
    if(JSON.stringify(d)!==JSON.stringify(list)){
      list=d; persist(); render();
      if(!silent) alert(`å·²ä»äº‘ç«¯åŒæ­¥ï¼š${currentRole}`);
    }else if(!silent){
      alert(`å·²æ˜¯æœ€æ–°ï¼š${currentRole}`);
    }
  }catch(e){ if(!silent) alert('æ‹‰å–å¤±è´¥ï¼š'+(e.message||e)); }
}
async function githubPutFile(cfg,path,content,message){
  const api=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path).replace(/%2F/g,'/')}`;
  let sha; const g=await fetch(`${api}?ref=${cfg.branch}`,{headers:{Authorization:`Bearer ${cfg.token}`,Accept:'application/vnd.github+json'}});
  if(g.ok){ const j=await g.json(); sha=j.sha; }
  const body={message,content:btoa(unescape(encodeURIComponent(content))),branch:cfg.branch}; if(sha) body.sha=sha;
  const r=await fetch(api,{method:'PUT',headers:{Authorization:`Bearer ${cfg.token}`,Accept:'application/vnd.github+json','Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok){ const t=await r.text(); if(r.status===401||r.status===403) throw new Error('AUTH_401'); throw new Error(t.slice(0,200)); }
}

$('openEditorBtn').addEventListener('click',()=>{ clearForm(); openEditor(); });
$('closeEditorBtn').addEventListener('click',closeEditor);
$('editorModal').addEventListener('click',e=>{ if(e.target.id==='editorModal') closeEditor(); });

$('entryForm').addEventListener('submit',e=>{
  e.preventDefault();
  const id=$('entryId').value.trim();
  const it={id:id||uid(),title:$('title').value.trim(),day:$('day').value,type:$('type').value,start:$('start').value,end:$('end').value,location:$('location').value.trim(),note:$('note').value.trim(),alarmOn:$('alarmOn').checked};
  if(!it.title||!it.start||!it.end) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
  if(it.start>=it.end) return alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´');
  if(it.alarmOn && 'Notification' in window && Notification.permission==='default') Notification.requestPermission().catch(()=>{});
  if(id){ const i=list.findIndex(x=>x.id===id); if(i>-1) list[i]=it; } else list.push(it);
  persist(); render(); closeEditor(); clearForm();
});
$('resetBtn').addEventListener('click',clearForm);
$('filterDay').addEventListener('change',render);

$('roleButtons').addEventListener('click',e=>{
  const b=e.target.closest('button[data-action]'); if(!b) return;
  const role=b.dataset.role, action=b.dataset.action;
  if(action==='switch'){ switchRole(role); return; }
  if(action==='rename'){
    const newName=(prompt('æ–°çš„è§’è‰²åç§°', role)||'').trim();
    if(!newName||newName===role) return;
    const roles=getRoles();
    if(roles.includes(newName)) return alert('è¯¥è§’è‰²åå·²å­˜åœ¨');
    const idx=roles.indexOf(role); if(idx===-1) return;
    const oldData=loadRole(role);
    roles[idx]=newName;
    setRoles(roles);
    localStorage.setItem(roleStorageKey(newName), JSON.stringify(oldData));
    localStorage.removeItem(roleStorageKey(role));
    if(currentRole===role) switchRole(newName); else renderRoles();
    return;
  }
  if(action==='delete'){
    const roles=getRoles();
    if(roles.length<=1) return alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªè§’è‰²');
    if(!confirm(`ç¡®å®šåˆ é™¤è§’è‰²ã€Œ${role}ã€å—ï¼Ÿè¯¥è§’è‰²è¯¾ç¨‹ä¼šä¸€å¹¶åˆ é™¤ã€‚`)) return;
    const nextRoles=roles.filter(r=>r!==role);
    localStorage.removeItem(roleStorageKey(role));
    setRoles(nextRoles);
    if(currentRole===role) switchRole(nextRoles[0]); else renderRoles();
  }
});
$('toggleRolesBtn').addEventListener('click',()=>{ const c=document.querySelector('.container'); applyRolesCollapsed(!c.classList.contains('roles-collapsed')); renderRoles(); });
$('addRoleBtn').addEventListener('click',()=>{ const name=(prompt('æ–°è§’è‰²åç§°')||'').trim(); if(!name) return; const roles=getRoles(); if(!roles.includes(name)) roles.push(name); setRoles(roles); switchRole(name); });

function onAction(e){ const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id, act=b.dataset.action, it=list.find(x=>x.id===id); if(!it) return; if(act==='edit') fillForm(it); if(act==='delete'){ if(!confirm(`ç¡®å®šåˆ é™¤ã€Œ${it.title}ã€å—ï¼Ÿ`)) return; list=list.filter(x=>x.id!==id); persist(); render(); } }
$('tbody').addEventListener('click',onAction); $('cardsGrid').addEventListener('click',onAction);

$('copyPrevDayBtn').addEventListener('click',()=>{ const target=$('filterDay').value; if(target==='å…¨éƒ¨') return alert('è¯·å…ˆç­›é€‰åˆ°ç›®æ ‡æ˜ŸæœŸ'); const prev=dayOrder[(dayOrder.indexOf(target)+6)%7]; const src=sortList(list).filter(x=>x.day===prev); if(!src.length) return alert(`${prev} æ²¡æœ‰å¯å¤åˆ¶è¯¾ç¨‹`); const keys=new Set(list.filter(x=>x.day===target).map(x=>`${x.start}|${x.end}|${x.title}|${x.type}|${x.location||''}|${x.note||''}`)); let n=0; for(const s of src){const k=`${s.start}|${s.end}|${s.title}|${s.type}|${s.location||''}|${s.note||''}`; if(keys.has(k)) continue; list.push({...s,id:uid(),day:target}); keys.add(k); n++;} persist(); render(); alert(`å·²ä» ${prev} å¤åˆ¶åˆ° ${target}ï¼šæ–°å¢ ${n} æ¡`); });

$('toggleViewBtn').addEventListener('click',()=>{ viewMode=viewMode==='table'?'card':'table'; syncViewMode(); });

function rows(){ return sortList(list).map(i=>[i.day,`${i.start} - ${i.end}`,i.title,i.type,i.location||'',i.note||'',alarmEnabled(i)?'å¼€':'å…³']); }
function dl(content,name,type){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),500); }
$('exportCsvBtn').addEventListener('click',()=>{ if(!list.length) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®'); const csv=[['æ˜ŸæœŸ','æ—¶é—´','äº‹é¡¹','ç±»å‹','åœ°ç‚¹','å¤‡æ³¨','é—¹é“ƒ'],...rows()].map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\r\n'); dl('\uFEFF'+csv,`${currentRole}-timetable.csv`,'text/csv;charset=utf-8;'); });
$('exportExcelBtn').addEventListener('click',()=>{ if(!list.length) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®'); const html=`<html><head><meta charset="UTF-8"></head><body><table border="1"><tr><th>æ˜ŸæœŸ</th><th>æ—¶é—´</th><th>äº‹é¡¹</th><th>ç±»å‹</th><th>åœ°ç‚¹</th><th>å¤‡æ³¨</th><th>é—¹é“ƒ</th></tr>${rows().map(r=>`<tr>${r.map(c=>`<td>${esc(c)}</td>`).join('')}</tr>`).join('')}</table></body></html>`; dl('\uFEFF'+html,`${currentRole}-timetable.xls`,'application/vnd.ms-excel;charset=utf-8;'); });

function buildImage(){
  const fd=$('filterDay').value, view=sortList(list).filter(i=>fd==='å…¨éƒ¨'||i.day===fd), days=fd==='å…¨éƒ¨'?dayOrder:[fd];
  const g=14,colW=178,hHead=30,hCard=210,gCard=8,top=92,max=Math.max(1,...days.map(d=>view.filter(x=>x.day===d).length));
  const contentH=g+hHead+g+max*hCard+Math.max(0,max-1)*gCard+g,w=days.length*colW+(days.length+1)*g,h=top+contentH;
  const c=document.createElement('canvas'),dpr=Math.max(2,window.devicePixelRatio||1),x=c.getContext('2d'); c.width=w*dpr;c.height=h*dpr;x.scale(dpr,dpr);
  const rr=(a,b,cw,ch,r)=>{x.beginPath();x.moveTo(a+r,b);x.arcTo(a+cw,b,a+cw,b+ch,r);x.arcTo(a+cw,b+ch,a,b+ch,r);x.arcTo(a,b+ch,a,b,r);x.arcTo(a,b,a+cw,b,r);x.closePath()};
  const bg=x.createLinearGradient(0,0,w,h); bg.addColorStop(0,'#1a2452'); bg.addColorStop(1,'#3b1f66'); x.fillStyle=bg; x.fillRect(0,0,w,h);
  x.fillStyle='#fff'; x.font='700 24px Segoe UI,Microsoft YaHei'; x.fillText(`ğŸ“… ${currentRole} Time Table`,18,36); x.font='500 14px Segoe UI,Microsoft YaHei'; x.fillText(fd==='å…¨éƒ¨'?`å…¨éƒ¨å®‰æ’ Â· å…± ${view.length} æ¡`:`${fd} Â· å…± ${view.length} æ¡`,18,58);
  days.forEach((day,di)=>{ const its=view.filter(v=>v.day===day),cx=g+di*(colW+g),cy=top+g; x.fillStyle='rgba(255,255,255,.1)'; rr(cx,cy,colW,contentH-g*2,12); x.fill(); x.strokeStyle='rgba(255,255,255,.18)'; x.stroke(); x.fillStyle='#fff'; x.font='700 14px Segoe UI,Microsoft YaHei'; x.fillText(day,cx+10,cy+20); x.fillStyle='rgba(255,255,255,.72)'; x.font='500 11px Segoe UI'; x.fillText(`${its.length} æ¡`,cx+colW-34,cy+20); if(!its.length){ x.fillText('æš‚æ— è¯¾ç¨‹',cx+10,cy+50); return; } its.forEach((it,i)=>{ const xx=cx+8,yy=cy+hHead+g+i*(hCard+gCard),ww=colW-16; x.fillStyle='rgba(255,255,255,.14)'; rr(xx,yy,ww,hCard,12); x.fill(); x.strokeStyle='rgba(255,255,255,.2)'; x.stroke(); x.fillStyle='#fff'; x.font='34px Segoe UI Emoji'; x.fillText(typeIcons[it.type]||'ğŸ“Œ',xx+8,yy+40); x.font='700 15px Segoe UI,Microsoft YaHei'; x.fillText((it.title||'').slice(0,10),xx+8,yy+66); x.font='500 12px Segoe UI,Microsoft YaHei'; x.fillText(`${it.start} - ${it.end}`,xx+8,yy+88); x.fillText(`${it.type} Â· ${(it.location||'-').slice(0,12)}`,xx+8,yy+110); x.fillStyle='rgba(255,255,255,.72)'; x.fillText(`é—¹é“ƒï¼š${alarmEnabled(it)?'å¼€':'å…³'}`,xx+8,yy+132); }); });
  return c;
}
$('exportImageBtn').addEventListener('click',()=>{ if(!list.length) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®'); const c=buildImage(); const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download=`${currentRole}-timetable.png`; a.click(); });
$('shareImageBtn').addEventListener('click',async()=>{ if(!list.length) return alert('æ²¡æœ‰å¯åˆ†äº«çš„æ•°æ®'); if(!navigator.share) return alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥åˆ†äº«ï¼Œè¯·å…ˆå¯¼å‡ºå›¾ç‰‡å†å‘å¾®ä¿¡ã€‚'); const c=buildImage(); const blob=await new Promise(r=>c.toBlob(r,'image/png')); if(!blob) return; const file=new File([blob],`${currentRole}-timetable.png`,{type:'image/png'}); try{ if(navigator.canShare && !navigator.canShare({files:[file]})) throw new Error(); await navigator.share({files:[file],title:`${currentRole}è¯¾ç¨‹è¡¨`}); }catch(e){ if(e.name!=='AbortError') alert('å½“å‰ç¯å¢ƒä¸èƒ½ç›´æ¥æ‹‰èµ·å¾®ä¿¡åˆ†äº«ï¼Œè¯·å¯¼å‡ºå›¾ç‰‡åå‘é€ã€‚'); } });

$('backupGithubBtn').addEventListener('click',async()=>{
  if(!list.length) return alert('å½“å‰æ²¡æœ‰å¯å¤‡ä»½çš„æ•°æ®');
  const cfg=readGithubCfg(); if(!cfg) return;
  const now=new Date(); const stamp=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
  const payload=JSON.stringify(list,null,2);
  try{ await githubPutFile(cfg,`backups/${currentRole}-timetable-${stamp}.json`,payload,`backup ${currentRole}: ${stamp}`); await githubPutFile(cfg,`backups/${currentRole}-latest.json`,payload,`backup latest ${currentRole}: ${stamp}`); await githubPutFile(cfg,`data-${currentRole}.json`,payload,`publish ${currentRole}: ${stamp}`); alert(`å¤‡ä»½æˆåŠŸï¼š${currentRole}`); }
  catch(e){ alert('å¤‡ä»½å¤±è´¥ï¼š'+(e.message||e)); }
});

$('restoreGithubBtn').addEventListener('click',async()=>{
  const cfg=readGithubCfg(); if(!cfg) return;
  const url=`https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/${cfg.branch}/backups/${encodeURIComponent(currentRole)}-latest.json?v=${Date.now()}`;
  try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('æœªæ‰¾åˆ°è¯¥è§’è‰²å¤‡ä»½'); const d=await r.json(); if(!Array.isArray(d)) throw new Error('å¤‡ä»½æ ¼å¼ä¸æ­£ç¡®'); if(!confirm(`å°†è¦†ç›– ${currentRole} æœ¬åœ°æ•°æ®ï¼Œå…± ${d.length} æ¡ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`)) return; list=d; persist(); render(); alert('æ¢å¤æˆåŠŸ'); }
  catch(e){ alert('æ¢å¤å¤±è´¥ï¼š'+(e.message||e)); }
});

$('forceRefreshBtn').addEventListener('click',async()=>{
  let cfg=readGithubCfg(); if(!cfg) return;
  const now=new Date();
  const stamp=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
  const run=async()=>{
    const roles=getRoles();
    for(const role of roles){
      const roleData=loadRole(role);
      const payload=JSON.stringify(roleData,null,2);
      await githubPutFile(cfg,`backups/${role}-latest.json`,payload,`sync latest ${role}: ${stamp}`);
      await githubPutFile(cfg,`data-${role}.json`,payload,`sync data ${role}: ${stamp}`);
    }
    // é¢å¤–åŒæ­¥ä¸€ä»½é€šç”¨ data.json ç»™ Jackson å…¼å®¹
    const jacksonData=loadRole('Jackson');
    if(Array.isArray(jacksonData)&&jacksonData.length){
      await githubPutFile(cfg,'data.json',JSON.stringify(jacksonData,null,2),`sync data Jackson(shared): ${stamp}`);
    }
    await pullLatestForRole(true);
  };
  try{ await run(); alert('åŒæ­¥æˆåŠŸï¼šå…¨éƒ¨è§’è‰²å·²åŒæ­¥'); }
  catch(e){
    if((e.message||'').includes('AUTH_401')){
      cfg=readGithubCfg(true); if(!cfg) return;
      try{ await run(); alert('åŒæ­¥æˆåŠŸï¼šå…¨éƒ¨è§’è‰²å·²åŒæ­¥'); return; }catch(err){ alert('åŒæ­¥å¤±è´¥ï¼šé‰´æƒæ— æ•ˆï¼Œè¯·æ£€æŸ¥PATæƒé™(repo)'); return; }
    }
    alert('åŒæ­¥å¤±è´¥ï¼š'+(e.message||e));
  }
});

(async function init(){
  migrateToJackson();
  const roles=getRoles();
  const saved=localStorage.getItem(ROLE_ACTIVE_KEY);
  currentRole=(saved&&roles.includes(saved))?saved:(roles[0]||'Jackson');
  list=loadRole(currentRole);
  const rc=localStorage.getItem(ROLES_COLLAPSED_KEY);
  const defaultRc=window.matchMedia('(max-width: 980px)').matches;
  applyRolesCollapsed(rc===null?defaultRc:rc==='1');
  renderRoles();
  syncViewMode();
  render();
  pullLatestForRole(true);
  setInterval(alarmTick,30000);
  document.addEventListener('visibilitychange',()=>{ if(!document.hidden){ alarmTick(); pullLatestForRole(true); } });
  window.addEventListener('focus', ()=>{ alarmTick(); pullLatestForRole(true); });
  alarmTick();
  if('serviceWorker' in navigator) window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
})();
</script>
</body>
</html>