<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1a2452" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Time Table" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>Time Table &#183; &#35838;&#31243;/&#26085;&#31243;&#31649;&#29702;</title>
  <style>
    :root {
      --bg: #0f1220;
      --card: rgba(255,255,255,.08);
      --card-strong: rgba(255,255,255,.14);
      --text: #eaf0ff;
      --muted: #b8c3e8;
      --primary: #6ea8ff;
      --accent: #9a7bff;
      --danger: #ff6f8e;
      --ok: #58d68d;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 800px at -10% -20%, #2b3f7f 0%, transparent 60%),
        radial-gradient(900px 700px at 120% 120%, #4a2c8a 0%, transparent 55%),
        var(--bg);
      min-height: 100vh;
      padding: 28px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 20px;
    }

    .panel {
      background: var(--card);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: var(--radius);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }

    .form-panel {
      padding: 18px;
      position: sticky;
      top: 20px;
      height: fit-content;
    }

    h1 {
      margin: 0 0 14px;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 16px;
    }

    label { font-size: 13px; color: var(--muted); display: block; margin: 10px 0 6px; }

    input, select, textarea {
      width: 100%;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(10,12,24,.45);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      transition: .18s;
    }

    textarea { min-height: 72px; resize: vertical; }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(110,168,255,.2);
    }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 14px; }

    button {
      border: 0;
      border-radius: 12px;
      padding: 10px 12px;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: transform .08s ease, opacity .2s;
    }

    button:active { transform: translateY(1px); }
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--accent)); }
    .btn-ghost { background: rgba(255,255,255,.12); }
    .btn-danger { background: linear-gradient(135deg, #ff5f7b, #ff7f5f); }

    .board {
      padding: 16px;
      display: grid;
      gap: 12px;
      grid-template-rows: auto auto 1fr;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    .toolbar .left,
    .toolbar .right {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .chip {
      font-size: 12px;
      color: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.16);
      border: 1px solid rgba(255,255,255,.2);
    }

    .table-wrap {
      overflow: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.15);
    }

    .view-wrap.hidden { display: none; }

    .cards-wrap {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.15);
      padding: 12px;
      background: rgba(8,10,20,.35);
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(170px, 1fr));
      gap: 12px;
      min-width: 980px;
    }

    .day-col {
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 12px;
      padding: 10px;
      min-height: 220px;
    }

    .day-col h3 {
      margin: 0 0 8px;
      font-size: 14px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .day-col .count {
      font-size: 11px;
      color: var(--muted);
    }

    .day-list {
      display: grid;
      gap: 8px;
      align-content: start;
    }

    .tt-card {
      background: linear-gradient(160deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 8px 20px rgba(0,0,0,.2);
      min-height: 210px;
      display: grid;
      grid-template-rows: 44px 42px 20px 20px 34px auto;
      align-items: start;
    }

    .tt-card .icon {
      font-size: 42px;
      line-height: 1;
      margin-bottom: 2px;
    }

    .tt-card .title {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 16px;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .tt-card .meta {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 2px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    .tt-card .card-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
      align-self: end;
    }

    .tt-card .card-actions button {
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 780px;
      background: rgba(8,10,20,.4);
    }

    th, td {
      border-bottom: 1px solid rgba(255,255,255,.12);
      text-align: left;
      padding: 11px;
      vertical-align: top;
      font-size: 14px;
    }

    th {
      background: rgba(255,255,255,.08);
      position: sticky;
      top: 0;
      z-index: 1;
      font-weight: 700;
    }

    tr:hover td { background: rgba(255,255,255,.06); }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(255,255,255,.1);
      margin-right: 4px;
    }

    .actions {
      display: flex;
      gap: 6px;
    }

    .actions button {
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 12px;
    }

    .muted { color: var(--muted); font-size: 12px; }

    .empty {
      text-align: center;
      padding: 28px;
      color: var(--muted);
    }

    @media (max-width: 980px) {
      .container { grid-template-columns: 1fr; }
      .form-panel { position: static; }
      body { padding: 14px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <aside class="panel form-panel">
      <h1>&#128197; Time Table</h1>
      <div class="sub">&#25903;&#25345;&#22686;&#21024;&#25913;&#26597;&#65288;&#26412;&#22320;&#33258;&#21160;&#20445;&#23384;&#65289;</div>

      <form id="entryForm">
        <input type="hidden" id="entryId" />

        <label for="title">&#35838;&#31243; / &#20107;&#39033;</label>
        <input id="title" required placeholder="&#20363;&#22914;&#65306;&#25968;&#23398; / &#39033;&#30446;&#26216;&#20250;" />

        <div class="row">
          <div>
            <label for="day">&#26143;&#26399;</label>
            <select id="day" required>
              <option value="&#21608;&#19968;">&#21608;&#19968;</option>
              <option value="&#21608;&#20108;">&#21608;&#20108;</option>
              <option value="&#21608;&#19977;">&#21608;&#19977;</option>
              <option value="&#21608;&#22235;">&#21608;&#22235;</option>
              <option value="&#21608;&#20116;">&#21608;&#20116;</option>
              <option value="&#21608;&#20845;">&#21608;&#20845;</option>
              <option value="&#21608;&#26085;">&#21608;&#26085;</option>
            </select>
          </div>
          <div>
            <label for="type">&#31867;&#22411;</label>
            <select id="type" required>
              <option value="&#35838;&#31243;">&#35838;&#31243;</option>
              <option value="&#20250;&#35758;">&#20250;&#35758;</option>
              <option value="&#23398;&#20064;">&#23398;&#20064;</option>
              <option value="&#38203;&#28860;">&#38203;&#28860;</option>
              <option value="&#38899;&#20048;">&#38899;&#20048;</option>
              <option value="&#33310;&#36424;">&#33310;&#36424;</option>
              <option value="&#20854;&#20182;">&#20854;&#20182;</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="start">&#24320;&#22987;&#26102;&#38388;</label>
            <input id="start" type="time" required />
          </div>
          <div>
            <label for="end">&#32467;&#26463;&#26102;&#38388;</label>
            <input id="end" type="time" required />
          </div>
        </div>

        <label for="location">&#22320;&#28857;</label>
        <input id="location" placeholder="&#20363;&#22914;&#65306;A-302 / Zoom" />

        <label for="note">&#22791;&#27880;</label>
        <textarea id="note" placeholder="&#21487;&#36873;"></textarea>

        <div class="btn-row">
          <button class="btn-primary" type="submit" id="saveBtn">&#26032;&#22686;</button>
          <button class="btn-ghost" type="button" id="resetBtn">&#28165;&#31354;</button>
        </div>
      </form>
    </aside>

    <main class="panel board">
      <div class="toolbar">
        <div class="left">
          <span class="chip" id="countChip">&#20849; 0 &#26465;</span>
          <select id="filterDay" title="&#25353;&#26143;&#26399;&#31579;&#36873;">
            <option value="&#20840;&#37096;">&#20840;&#37096;&#26143;&#26399;</option>
            <option value="&#21608;&#19968;">&#21608;&#19968;</option>
            <option value="&#21608;&#20108;">&#21608;&#20108;</option>
            <option value="&#21608;&#19977;">&#21608;&#19977;</option>
            <option value="&#21608;&#22235;">&#21608;&#22235;</option>
            <option value="&#21608;&#20116;">&#21608;&#20116;</option>
            <option value="&#21608;&#20845;">&#21608;&#20845;</option>
            <option value="&#21608;&#26085;">&#21608;&#26085;</option>
          </select>
        </div>
        <div class="right">
          <button class="btn-ghost" id="copyPrevDayBtn" type="button">&#22797;&#21046;&#21069;&#19968;&#22825;</button>
          <button class="btn-ghost" id="toggleViewBtn" type="button">&#20999;&#25442;&#21040;&#21345;&#29255;&#27169;&#24335;</button>
          <button class="btn-ghost" id="exportImageBtn" type="button">&#23548;&#20986;&#22270;&#29255;</button>
          <button class="btn-ghost" id="shareImageBtn" type="button">&#20998;&#20139;&#22270;&#29255;</button>
          <button class="btn-ghost" id="exportCsvBtn" type="button">&#23548;&#20986; CSV</button>
          <button class="btn-ghost" id="exportExcelBtn" type="button">&#23548;&#20986; Excel</button>
          <button class="btn-danger" id="clearAllBtn" type="button">&#28165;&#31354;&#20840;&#37096;</button>
        </div>
      </div>

      <div class="muted">&#25552;&#31034;&#65306;&#28857;&#20987;&#8220;&#32534;&#36753;&#8221;&#21487;&#20462;&#25913;&#65307;&#21024;&#38500;&#21518;&#19981;&#21487;&#24674;&#22797;&#12290;&#25968;&#25454;&#20445;&#23384;&#22312;&#27983;&#35272;&#22120;&#26412;&#22320;&#65288;localStorage&#65289;&#12290;</div>

      <div id="tableWrap" class="table-wrap view-wrap">
        <table>
          <thead>
            <tr>
              <th>&#26143;&#26399;</th>
              <th>&#26102;&#38388;</th>
              <th>&#22270;&#26631;</th>
              <th>&#20107;&#39033;</th>
              <th>&#31867;&#22411;</th>
              <th>&#22320;&#28857;</th>
              <th>&#22791;&#27880;</th>
              <th>&#25805;&#20316;</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="cardsWrap" class="cards-wrap view-wrap hidden">
        <div id="cardsGrid" class="cards-grid"></div>
      </div>

      <div id="empty" class="empty">&#36824;&#27809;&#26377;&#23433;&#25490;&#65292;&#20808;&#22312;&#24038;&#20391;&#28155;&#21152;&#31532;&#19968;&#26465;&#21543; &#10024;</div>
    </main>
  </div>

  <script>
    const STORAGE_KEY = 'pretty_timetable_v1';
    const dayOrder = ['&#21608;&#19968;','&#21608;&#20108;','&#21608;&#19977;','&#21608;&#22235;','&#21608;&#20116;','&#21608;&#20845;','&#21608;&#26085;'];
    const typeIcons = {
      '&#35838;&#31243;': '&#128216;',
      '&#20250;&#35758;': '&#129489;&#8205;&#128188;',
      '&#23398;&#20064;': '&#129504;',
      '&#38203;&#28860;': '&#127939;',
      '&#38899;&#20048;': '&#127925;',
      '&#33310;&#36424;': '&#128131;',
      '&#20854;&#20182;': '&#128450;&#65039;'
    };

    const $ = (id) => document.getElementById(id);

    const form = $('entryForm');
    const tbody = $('tbody');
    const cardsGrid = $('cardsGrid');
    const tableWrap = $('tableWrap');
    const cardsWrap = $('cardsWrap');
    const toggleViewBtn = $('toggleViewBtn');
    const empty = $('empty');
    const countChip = $('countChip');
    const saveBtn = $('saveBtn');

    let viewMode = 'table';

    let list = load();

    function load() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      } catch {
        return [];
      }
    }

    function persist() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function uid() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    }

    function sortList(arr) {
      return [...arr].sort((a, b) => {
        const d = dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
        if (d !== 0) return d;
        return a.start.localeCompare(b.start);
      });
    }

    function timeValid(start, end) {
      return start < end;
    }

    function clearForm() {
      $('entryId').value = '';
      form.reset();
      saveBtn.textContent = '&#26032;&#22686;';
      $('day').value = '&#21608;&#19968;';
      $('type').value = '&#35838;&#31243;';
    }

    function fillForm(item) {
      $('entryId').value = item.id;
      $('title').value = item.title;
      $('day').value = item.day;
      $('type').value = item.type;
      $('start').value = item.start;
      $('end').value = item.end;
      $('location').value = item.location || '';
      $('note').value = item.note || '';
      saveBtn.textContent = '&#20445;&#23384;&#20462;&#25913;';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function render() {
      const filterDay = $('filterDay').value;
      const view = sortList(list).filter(i => filterDay === '&#20840;&#37096;' || i.day === filterDay);

      tbody.innerHTML = '';
      cardsGrid.innerHTML = '';
      empty.style.display = view.length ? 'none' : 'block';
      countChip.textContent = `&#20849; ${view.length} &#26465;`;

      for (const item of view) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.day}</td>
          <td><span class="pill">${item.start} - ${item.end}</span></td>
          <td title="${escapeHtml(item.type)}" style="font-size:20px;line-height:1;">${typeIcons[item.type] || '&#128204;'}</td>
          <td>${escapeHtml(item.title)}</td>
          <td>${escapeHtml(item.type)}</td>
          <td>${escapeHtml(item.location || '-')}</td>
          <td>${escapeHtml(item.note || '-')}</td>
          <td>
            <div class="actions">
              <button class="btn-ghost" data-action="edit" data-id="${item.id}">&#32534;&#36753;</button>
              <button class="btn-danger" data-action="delete" data-id="${item.id}">&#21024;&#38500;</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      const daysToShow = filterDay === '&#20840;&#37096;' ? dayOrder : [filterDay];
      for (const day of daysToShow) {
        const dayItems = view.filter(x => x.day === day);
        const col = document.createElement('div');
        col.className = 'day-col';

        const listHtml = dayItems.length
          ? dayItems.map(item => `
            <div class="tt-card">
              <div class="icon">${typeIcons[item.type] || '&#128204;'}</div>
              <div class="title">${escapeHtml(item.title)}</div>
              <div class="meta">${escapeHtml(item.start)} - ${escapeHtml(item.end)}</div>
              <div class="meta">${escapeHtml(item.type)} &#183; ${escapeHtml(item.location || '-')}</div>
              <div class="meta">${escapeHtml(item.note || '-')}</div>
              <div class="card-actions">
                <button class="btn-ghost" data-action="edit" data-id="${item.id}">&#32534;&#36753;</button>
                <button class="btn-danger" data-action="delete" data-id="${item.id}">&#21024;&#38500;</button>
              </div>
            </div>
          `).join('')
          : '<div class="muted">&#26242;&#26080;&#35838;&#31243;</div>';

        col.innerHTML = `
          <h3>${day}<span class="count">${dayItems.length} &#26465;</span></h3>
          <div class="day-list">${listHtml}</div>
        `;
        cardsGrid.appendChild(col);
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const id = $('entryId').value.trim();

      const item = {
        id: id || uid(),
        title: $('title').value.trim(),
        day: $('day').value,
        type: $('type').value,
        start: $('start').value,
        end: $('end').value,
        location: $('location').value.trim(),
        note: $('note').value.trim()
      };

      if (!item.title || !item.start || !item.end) {
        alert('&#35831;&#22635;&#20889;&#23436;&#25972;&#20449;&#24687;');
        return;
      }
      if (!timeValid(item.start, item.end)) {
        alert('&#32467;&#26463;&#26102;&#38388;&#24517;&#39035;&#26202;&#20110;&#24320;&#22987;&#26102;&#38388;');
        return;
      }

      if (id) {
        const idx = list.findIndex(x => x.id === id);
        if (idx !== -1) list[idx] = item;
      } else {
        list.push(item);
      }

      persist();
      render();
      clearForm();
    });

    $('resetBtn').addEventListener('click', clearForm);

    $('filterDay').addEventListener('change', render);

    function formatExportRows() {
      return sortList(list).map(item => [
        item.day,
        `${item.start} - ${item.end}`,
        item.title,
        item.type,
        item.location || '',
        item.note || ''
      ]);
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCSV() {
      if (!list.length) {
        alert('&#27809;&#26377;&#21487;&#23548;&#20986;&#30340;&#25968;&#25454;');
        return;
      }
      const header = ['&#26143;&#26399;', '&#26102;&#38388;', '&#20107;&#39033;', '&#31867;&#22411;', '&#22320;&#28857;', '&#22791;&#27880;'];
      const rows = formatExportRows();
      const csv = [header, ...rows]
        .map(cols => cols.map(v => `"${String(v).replaceAll('"', '""')}"`).join(','))
        .join('\r\n');
      downloadFile('\uFEFF' + csv, 'timetable.csv', 'text/csv;charset=utf-8;');
    }

    function exportExcel() {
      if (!list.length) {
        alert('&#27809;&#26377;&#21487;&#23548;&#20986;&#30340;&#25968;&#25454;');
        return;
      }
      const rows = formatExportRows();
      const html = `
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="UTF-8"></head>
<body>
<table border="1">
  <tr><th>&#26143;&#26399;</th><th>&#26102;&#38388;</th><th>&#20107;&#39033;</th><th>&#31867;&#22411;</th><th>&#22320;&#28857;</th><th>&#22791;&#27880;</th></tr>
  ${rows.map(r => `<tr>${r.map(c => `<td>${escapeHtml(c)}</td>`).join('')}</tr>`).join('')}
</table>
</body>
</html>`;
      downloadFile('\uFEFF' + html, 'timetable.xls', 'application/vnd.ms-excel;charset=utf-8;');
    }

    function buildExportCanvas() {
      const filterDay = $('filterDay').value;
      const view = sortList(list).filter(i => filterDay === '&#20840;&#37096;' || i.day === filterDay);
      const daysToShow = filterDay === '&#20840;&#37096;' ? dayOrder : [filterDay];

      const pageGap = 14;
      const colW = 178;
      const colHeadH = 30;
      const cardH = 210;
      const cardGap = 8;
      const topH = 92;

      const maxCards = Math.max(1, ...daysToShow.map(day => view.filter(x => x.day === day).length));
      const contentH = pageGap + colHeadH + pageGap + maxCards * cardH + Math.max(0, maxCards - 1) * cardGap + pageGap;
      const width = daysToShow.length * colW + (daysToShow.length + 1) * pageGap;
      const height = topH + contentH;

      const canvas = document.createElement('canvas');
      const dpr = Math.max(2, window.devicePixelRatio || 1);
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);

      function roundRect(x, y, w, h, r) {
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.arcTo(x + w, y, x + w, y + h, r);
        ctx.arcTo(x + w, y + h, x, y + h, r);
        ctx.arcTo(x, y + h, x, y, r);
        ctx.arcTo(x, y, x + w, y, r);
        ctx.closePath();
      }

      const bg = ctx.createLinearGradient(0, 0, width, height);
      bg.addColorStop(0, '#1a2452');
      bg.addColorStop(1, '#3b1f66');
      ctx.fillStyle = bg;
      ctx.fillRect(0, 0, width, height);

      ctx.fillStyle = '#ffffff';
      ctx.font = '700 28px Segoe UI, Microsoft YaHei, sans-serif';
      ctx.fillText('&#128197; Time Table', 18, 38);
      ctx.font = '500 14px Segoe UI, Microsoft YaHei, sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,.88)';
      ctx.fillText(filterDay === '&#20840;&#37096;' ? `&#20840;&#37096;&#23433;&#25490; &#183; &#20849; ${view.length} &#26465;` : `${filterDay} &#183; &#20849; ${view.length} &#26465;`, 18, 62);
      ctx.fillStyle = 'rgba(255,255,255,.7)';
      ctx.fillText(`&#23548;&#20986;&#26102;&#38388;&#65306;${new Date().toLocaleString()}`, 18, 82);

      daysToShow.forEach((day, dayIdx) => {
        const dayItems = view.filter(x => x.day === day);
        const colX = pageGap + dayIdx * (colW + pageGap);
        const colY = topH + pageGap;

        ctx.fillStyle = 'rgba(255,255,255,.10)';
        roundRect(colX, colY, colW, contentH - pageGap * 2, 12);
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,.18)';
        ctx.stroke();

        ctx.fillStyle = '#fff';
        ctx.font = '700 14px Segoe UI, Microsoft YaHei, sans-serif';
        ctx.fillText(day, colX + 10, colY + 20);
        ctx.fillStyle = 'rgba(255,255,255,.72)';
        ctx.font = '500 11px Segoe UI, Microsoft YaHei, sans-serif';
        ctx.fillText(`${dayItems.length} &#26465;`, colX + colW - 36, colY + 20);

        if (!dayItems.length) {
          ctx.fillStyle = 'rgba(255,255,255,.55)';
          ctx.font = '500 12px Segoe UI, Microsoft YaHei, sans-serif';
          ctx.fillText('&#26242;&#26080;&#35838;&#31243;', colX + 10, colY + 50);
          return;
        }

        dayItems.forEach((item, i) => {
          const x = colX + 8;
          const y = colY + colHeadH + pageGap + i * (cardH + cardGap);
          const w = colW - 16;

          ctx.fillStyle = 'rgba(255,255,255,.14)';
          roundRect(x, y, w, cardH, 12);
          ctx.fill();
          ctx.strokeStyle = 'rgba(255,255,255,.2)';
          ctx.stroke();

          ctx.font = '34px Segoe UI Emoji, Segoe UI, sans-serif';
          ctx.fillStyle = '#fff';
          ctx.fillText(typeIcons[item.type] || '&#128204;', x + 8, y + 40);

          ctx.fillStyle = '#fff';
          ctx.font = '700 15px Segoe UI, Microsoft YaHei, sans-serif';
          ctx.fillText((item.title || '').slice(0, 10), x + 8, y + 66);

          ctx.fillStyle = 'rgba(255,255,255,.9)';
          ctx.font = '500 12px Segoe UI, Microsoft YaHei, sans-serif';
          ctx.fillText(`${item.start} - ${item.end}`, x + 8, y + 88);
          ctx.fillText(`${item.type} &#183; ${(item.location || '-').slice(0, 12)}`, x + 8, y + 110);
          ctx.fillStyle = 'rgba(255,255,255,.72)';
          ctx.fillText(`&#22791;&#27880;&#65306;${(item.note || '-').slice(0, 12)}`, x + 8, y + 132);
        });
      });

      return canvas;
    }

    function exportImage() {
      if (!list.length) {
        alert('&#27809;&#26377;&#21487;&#23548;&#20986;&#30340;&#25968;&#25454;');
        return;
      }
      const canvas = buildExportCanvas();
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'timetable.png';
      a.click();
    }

    async function shareImage() {
      if (!list.length) {
        alert('&#27809;&#26377;&#21487;&#20998;&#20139;&#30340;&#25968;&#25454;');
        return;
      }
      if (!navigator.share) {
        alert('&#24403;&#21069;&#27983;&#35272;&#22120;&#19981;&#25903;&#25345;&#30452;&#25509;&#20998;&#20139;&#65292;&#35831;&#20808;&#28857;&#8220;&#23548;&#20986;&#22270;&#29255;&#8221;&#20877;&#21457;&#32473;&#24494;&#20449;&#22909;&#21451;&#12290;');
        return;
      }

      const canvas = buildExportCanvas();
      const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
      if (!blob) {
        alert('&#29983;&#25104;&#22270;&#29255;&#22833;&#36133;&#65292;&#35831;&#37325;&#35797;');
        return;
      }

      const file = new File([blob], 'timetable.png', { type: 'image/png' });
      const shareData = { files: [file], title: '&#35838;&#31243;&#34920;', text: '&#25105;&#30340;&#35838;&#31243;&#34920;' };

      try {
        if (navigator.canShare && !navigator.canShare({ files: [file] })) {
          throw new Error('&#24403;&#21069;&#29615;&#22659;&#19981;&#25903;&#25345;&#25991;&#20214;&#20998;&#20139;');
        }
        await navigator.share(shareData);
      } catch (err) {
        if (err?.name !== 'AbortError') {
          alert('&#24403;&#21069;&#29615;&#22659;&#19981;&#33021;&#30452;&#25509;&#25289;&#36215;&#24494;&#20449;&#20998;&#20139;&#65292;&#35831;&#29992;&#8220;&#23548;&#20986;&#22270;&#29255;&#8221;&#21518;&#22312;&#24494;&#20449;&#37324;&#21457;&#36865;&#12290;');
        }
      }
    }

    function copyFromPreviousDay() {
      const targetDay = $('filterDay').value;
      if (targetDay === '&#20840;&#37096;') {
        alert('&#35831;&#20808;&#22312;&#31579;&#36873;&#37324;&#36873;&#25321;&#30446;&#26631;&#26143;&#26399;&#65292;&#20877;&#22797;&#21046;&#21069;&#19968;&#22825;&#35838;&#31243;');
        return;
      }

      const targetIdx = dayOrder.indexOf(targetDay);
      if (targetIdx === -1) return;
      const prevDay = dayOrder[(targetIdx + dayOrder.length - 1) % dayOrder.length];

      const sourceItems = sortList(list).filter(x => x.day === prevDay);
      if (!sourceItems.length) {
        alert(`${prevDay} &#27809;&#26377;&#21487;&#22797;&#21046;&#30340;&#35838;&#31243;`);
        return;
      }

      const existedKeys = new Set(
        list
          .filter(x => x.day === targetDay)
          .map(x => `${x.start}|${x.end}|${x.title}|${x.type}|${x.location || ''}|${x.note || ''}`)
      );

      let added = 0;
      for (const s of sourceItems) {
        const key = `${s.start}|${s.end}|${s.title}|${s.type}|${s.location || ''}|${s.note || ''}`;
        if (existedKeys.has(key)) continue;
        list.push({ ...s, id: uid(), day: targetDay });
        existedKeys.add(key);
        added++;
      }

      persist();
      render();
      alert(`&#24050;&#20174; ${prevDay} &#22797;&#21046;&#21040; ${targetDay}&#65306;&#26032;&#22686; ${added} &#26465;`);
    }

    $('copyPrevDayBtn').addEventListener('click', copyFromPreviousDay);
    $('exportImageBtn').addEventListener('click', exportImage);
    $('shareImageBtn').addEventListener('click', shareImage);
    $('exportCsvBtn').addEventListener('click', exportCSV);
    $('exportExcelBtn').addEventListener('click', exportExcel);

    function setViewMode(mode) {
      viewMode = mode;
      const isCard = mode === 'card';
      tableWrap.classList.toggle('hidden', isCard);
      cardsWrap.classList.toggle('hidden', !isCard);
      toggleViewBtn.textContent = isCard ? '&#20999;&#25442;&#21040;&#34920;&#26684;&#27169;&#24335;' : '&#20999;&#25442;&#21040;&#21345;&#29255;&#27169;&#24335;';
    }

    toggleViewBtn.addEventListener('click', () => {
      setViewMode(viewMode === 'table' ? 'card' : 'table');
    });

    function onActionClick(e) {
      const btn = e.target.closest('button');
      if (!btn) return;

      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const item = list.find(x => x.id === id);
      if (!item) return;

      if (action === 'edit') {
        fillForm(item);
      }

      if (action === 'delete') {
        if (!confirm(`&#30830;&#23450;&#21024;&#38500;&#12300;${item.title}&#12301;&#21527;&#65311;`)) return;
        list = list.filter(x => x.id !== id);
        persist();
        render();
      }
    }

    tbody.addEventListener('click', onActionClick);
    cardsGrid.addEventListener('click', onActionClick);

    $('clearAllBtn').addEventListener('click', () => {
      if (!list.length) return;
      if (!confirm('&#30830;&#23450;&#28165;&#31354;&#20840;&#37096;&#23433;&#25490;&#21527;&#65311;&#27492;&#25805;&#20316;&#19981;&#21487;&#24674;&#22797;&#12290;')) return;
      list = [];
      persist();
      render();
      clearForm();
    });

    // &#21021;&#22987;&#40664;&#35748;&#20540;
    $('day').value = '&#21608;&#19968;';
    $('type').value = '&#35838;&#31243;';
    setViewMode('table');
    render();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>