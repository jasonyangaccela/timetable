<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#1a2452" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Time Table" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>Time Table Â· è¯¾ç¨‹/æ—¥ç¨‹ç®¡ç†</title>
  <style>
    :root{--bg:#0f1220;--card:rgba(255,255,255,.08);--text:#eaf0ff;--muted:#b8c3e8;--primary:#6ea8ff;--accent:#9a7bff;--danger:#ff6f8e}
    *{box-sizing:border-box} body{margin:0;padding:24px;font-family:"Segoe UI","PingFang SC","Microsoft YaHei",sans-serif;color:var(--text);background:radial-gradient(1200px 800px at -10% -20%, #2b3f7f 0%, transparent 60%),radial-gradient(900px 700px at 120% 120%, #4a2c8a 0%, transparent 55%),var(--bg)}
    .container{max-width:1280px;margin:0 auto;display:grid;grid-template-columns:340px 1fr;gap:16px}.panel{background:var(--card);border:1px solid rgba(255,255,255,.15);border-radius:14px;backdrop-filter:blur(8px)}
    .form{padding:16px;position:sticky;top:16px;height:fit-content}.sub{font-size:13px;color:var(--muted);margin-bottom:12px}
    .editor-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px}
    .editor-head h2{margin:0}
    .collapsed-editor .container{grid-template-columns:84px 1fr}
    .collapsed-editor .form{padding:12px 10px}
    .collapsed-editor .form #entryForm,.collapsed-editor .form .sub{display:none}
    .collapsed-editor .editor-head{margin-bottom:0}
    .collapsed-editor #toggleEditorBtn{writing-mode:vertical-rl;height:120px}
    label{display:block;font-size:13px;color:var(--muted);margin:8px 0 4px} input,select,textarea,button{font:inherit}
    input,select,textarea{width:100%;padding:9px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(10,12,24,.45);color:var(--text)} textarea{min-height:62px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}.btn-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    button{border:0;padding:9px 10px;border-radius:10px;color:#fff;cursor:pointer}.btn-primary{background:linear-gradient(135deg,var(--primary),var(--accent))}.btn-ghost{background:rgba(255,255,255,.12)}.btn-danger{background:linear-gradient(135deg,#ff5f7b,#ff7f5f)}
    .board{padding:12px}.toolbar{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}.left,.right{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.chip{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.15)}
    .muted{color:var(--muted);font-size:12px}.table-wrap{overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,.15);margin-top:8px}.hidden{display:none!important}
    table{width:100%;min-width:880px;border-collapse:collapse;background:rgba(8,10,20,.4)} th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:14px;text-align:left} th{background:rgba(255,255,255,.08)}
    .pill{padding:4px 8px;border:1px solid rgba(255,255,255,.2);border-radius:999px;font-size:12px}.actions{display:flex;gap:6px}.actions button{padding:6px 9px;font-size:12px}
    .cards-wrap{margin-top:8px;border-radius:12px;border:1px solid rgba(255,255,255,.15);padding:10px;overflow:auto}.cards-grid{display:grid;grid-template-columns:repeat(7,minmax(170px,1fr));gap:10px;min-width:980px}
    .day-col{border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:8px;background:rgba(255,255,255,.06)} .day-col h3{margin:0 0 8px;font-size:14px;display:flex;justify-content:space-between}
    .day-list{display:grid;gap:8px;align-content:start}.tt-card{border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:9px;background:linear-gradient(160deg, rgba(255,255,255,.12), rgba(255,255,255,.06));min-height:208px;display:grid;grid-template-rows:44px 38px 18px 18px 30px auto}
    .icon{font-size:40px;line-height:1}.title{font-size:15px;font-weight:700;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}.meta{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.card-actions{display:flex;gap:6px;align-self:end}.card-actions button{padding:6px 9px;font-size:12px}
    .empty{text-align:center;padding:20px;color:var(--muted)}
    @media (max-width:980px){.container{grid-template-columns:1fr} .form{position:static} body{padding:12px}}
  </style>
</head>
<body>
<div class="container">
  <aside class="panel form">
    <div class="editor-head">
      <h2>ğŸ“… Time Table</h2>
      <button class="btn-ghost" id="toggleEditorBtn" type="button">æ”¶èµ·ç¼–è¾‘</button>
    </div>
    <div class="sub">æ”¯æŒå¢åˆ æ”¹æŸ¥ï¼ˆæœ¬åœ°è‡ªåŠ¨ä¿å­˜ï¼‰</div>
    <form id="entryForm">
      <input type="hidden" id="entryId" />
      <label>è¯¾ç¨‹ / äº‹é¡¹</label><input id="title" required placeholder="ä¾‹å¦‚ï¼šæ•°å­¦ / é¡¹ç›®æ™¨ä¼š" />
      <div class="row">
        <div><label>æ˜ŸæœŸ</label><select id="day"><option>å‘¨ä¸€</option><option>å‘¨äºŒ</option><option>å‘¨ä¸‰</option><option>å‘¨å››</option><option>å‘¨äº”</option><option>å‘¨å…­</option><option>å‘¨æ—¥</option></select></div>
        <div><label>ç±»å‹</label><select id="type"><option>è¯¾ç¨‹</option><option>ä¼šè®®</option><option>å­¦ä¹ </option><option>é”»ç‚¼</option><option>éŸ³ä¹</option><option>èˆè¹ˆ</option><option>å…¶ä»–</option></select></div>
      </div>
      <div class="row"><div><label>å¼€å§‹æ—¶é—´</label><input id="start" type="time" required /></div><div><label>ç»“æŸæ—¶é—´</label><input id="end" type="time" required /></div></div>
      <label>åœ°ç‚¹</label><input id="location" placeholder="ä¾‹å¦‚ï¼šA-302 / Zoom" />
      <label>å¤‡æ³¨</label><textarea id="note" placeholder="å¯é€‰"></textarea>
      <label style="display:flex;align-items:center;gap:8px;margin-top:10px;"><input id="alarmOn" type="checkbox" checked style="width:auto;"> å¼€å¯é—¹é“ƒï¼ˆè¯¾å‰5åˆ†é’Ÿï¼‰</label>
      <div class="btn-row"><button class="btn-primary" id="saveBtn" type="submit">æ–°å¢</button><button class="btn-ghost" type="button" id="resetBtn">æ¸…ç©º</button></div>
    </form>
  </aside>

  <main class="panel board">
    <div class="toolbar">
      <div class="left"><span class="chip" id="countChip">å…± 0 æ¡</span><span class="chip" id="alarmStateChip">é—¹é“ƒï¼šå…³</span>
        <select id="filterDay"><option value="å…¨éƒ¨">å…¨éƒ¨æ˜ŸæœŸ</option><option>å‘¨ä¸€</option><option>å‘¨äºŒ</option><option>å‘¨ä¸‰</option><option>å‘¨å››</option><option>å‘¨äº”</option><option>å‘¨å…­</option><option>å‘¨æ—¥</option></select>
      </div>
      <div class="right">
        <button class="btn-ghost" id="copyPrevDayBtn" type="button">å¤åˆ¶å‰ä¸€å¤©</button>
        <button class="btn-ghost" id="toggleAlarmBtn" type="button">æ‰“å¼€é—¹é“ƒ</button>
        <button class="btn-ghost" id="backupGithubBtn" type="button">å¤‡ä»½åˆ° GitHub</button>
        <button class="btn-ghost" id="restoreGithubBtn" type="button">æ¢å¤æœ€è¿‘å¤‡ä»½</button>
        <button class="btn-ghost" id="forceRefreshBtn" type="button">å¼ºåˆ¶æ›´æ–°</button>
        <button class="btn-ghost" id="toggleViewBtn" type="button">åˆ‡æ¢åˆ°å¡ç‰‡æ¨¡å¼</button>
        <button class="btn-ghost" id="exportImageBtn" type="button">å¯¼å‡ºå›¾ç‰‡</button>
        <button class="btn-ghost" id="shareImageBtn" type="button">åˆ†äº«å›¾ç‰‡</button>
        <button class="btn-ghost" id="exportCsvBtn" type="button">å¯¼å‡º CSV</button>
        <button class="btn-ghost" id="exportExcelBtn" type="button">å¯¼å‡º Excel</button>
        <button class="btn-danger" id="clearAllBtn" type="button">æ¸…ç©ºå…¨éƒ¨</button>
      </div>
    </div>

    <div class="muted">æç¤ºï¼šç‚¹å‡»â€œç¼–è¾‘â€å¯ä¿®æ”¹ï¼›åˆ é™¤åä¸å¯æ¢å¤ã€‚æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼ˆlocalStorageï¼‰ã€‚</div>

    <div id="tableWrap" class="table-wrap"><table><thead><tr><th>æ˜ŸæœŸ</th><th>æ—¶é—´</th><th>å›¾æ ‡</th><th>äº‹é¡¹</th><th>ç±»å‹</th><th>åœ°ç‚¹</th><th>å¤‡æ³¨</th><th>é—¹é“ƒ</th><th>æ“ä½œ</th></tr></thead><tbody id="tbody"></tbody></table></div>
    <div id="cardsWrap" class="cards-wrap hidden"><div id="cardsGrid" class="cards-grid"></div></div>
    <div id="empty" class="empty">è¿˜æ²¡æœ‰å®‰æ’ï¼Œå…ˆåœ¨å·¦ä¾§æ·»åŠ ç¬¬ä¸€æ¡å§ âœ¨</div>
  </main>
</div>

<script>
const STORAGE_KEY='pretty_timetable_v1';
const GITHUB_CFG_KEY='timetable_github_cfg_v1';
const EDITOR_COLLAPSED_KEY='timetable_editor_collapsed_v1';
const ALARM_MASTER_KEY='timetable_alarm_master_v1';
const ALARM_FIRED_KEY='timetable_alarm_fired_v1';
const dayOrder=['å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'];
const typeIcons={è¯¾ç¨‹:'ğŸ“˜',ä¼šè®®:'ğŸ§‘â€ğŸ’¼',å­¦ä¹ :'ğŸ§ ',é”»ç‚¼:'ğŸƒ',éŸ³ä¹:'ğŸµ',èˆè¹ˆ:'ğŸ’ƒ',å…¶ä»–:'ğŸ—‚ï¸'};
const $=id=>document.getElementById(id);
let list=load(),viewMode='card';

function load(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]')}catch{return[]}}
function persist(){localStorage.setItem(STORAGE_KEY,JSON.stringify(list))}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,7)}
function sortList(arr){return [...arr].sort((a,b)=>{const d=dayOrder.indexOf(a.day)-dayOrder.indexOf(b.day); return d||a.start.localeCompare(b.start)})}
function esc(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;')}
function isAlarmEnabled(){ return localStorage.getItem(ALARM_MASTER_KEY)==='1'; }
function setAlarmEnabled(v){ localStorage.setItem(ALARM_MASTER_KEY, v?'1':'0'); updateAlarmUI(); }
function getFiredMap(){ try{return JSON.parse(localStorage.getItem(ALARM_FIRED_KEY)||'{}')}catch{return{}} }
function setFiredMap(m){ localStorage.setItem(ALARM_FIRED_KEY, JSON.stringify(m)); }
function updateAlarmUI(){ const on=isAlarmEnabled(); $('alarmStateChip').textContent=`é—¹é“ƒï¼š${on?'å¼€':'å…³'}`; $('toggleAlarmBtn').textContent=on?'å…³é—­é—¹é“ƒ':'æ‰“å¼€é—¹é“ƒ'; }
function getNextOccurrence(item, now=new Date()){
  const dayMap={'å‘¨æ—¥':0,'å‘¨ä¸€':1,'å‘¨äºŒ':2,'å‘¨ä¸‰':3,'å‘¨å››':4,'å‘¨äº”':5,'å‘¨å…­':6};
  const t=(item.start||'00:00').split(':'); const hh=Number(t[0]||0), mm=Number(t[1]||0);
  const target=dayMap[item.day]; if(target===undefined) return null;
  const d=new Date(now); d.setHours(hh,mm,0,0);
  const ahead=(target-now.getDay()+7)%7; d.setDate(now.getDate()+ahead);
  if(d.getTime()-5*60*1000<=now.getTime()) d.setDate(d.getDate()+7);
  return d;
}
function alarmTick(){
  if(!isAlarmEnabled()||!Array.isArray(list)||!list.length) return;
  const now=new Date(); const fired=getFiredMap(); let changed=false;
  for(const item of list){
    if(item.alarmOn===false) continue;
    const start=getNextOccurrence(item, now); if(!start) continue;
    const remindAt=start.getTime()-5*60*1000;
    const key=`${item.id}_${start.toISOString().slice(0,10)}_${item.start}`;
    if(now.getTime()>=remindAt && now.getTime()<start.getTime() && !fired[key]){
      const msg=`${item.title} ${item.day} ${item.start} å³å°†å¼€å§‹ï¼ˆ5åˆ†é’Ÿåï¼‰`;
      if('Notification' in window && Notification.permission==='granted') new Notification('è¯¾ç¨‹æé†’', { body: msg });
      else alert(`ğŸ”” ${msg}`);
      fired[key]=Date.now(); changed=true;
    }
  }
  if(changed) setFiredMap(fired);
}

async function hydrateFromPublishedData(){
  if(Array.isArray(list)&&list.length>0) return;
  try{const r=await fetch('./data.json',{cache:'no-store'}); if(!r.ok) return; const d=await r.json(); if(Array.isArray(d)&&d.length){list=d;persist();}}catch{}
}

function getGithubCfg(){
  try{return JSON.parse(localStorage.getItem(GITHUB_CFG_KEY)||'{}')}catch{return{}}
}
function setGithubCfg(cfg){ localStorage.setItem(GITHUB_CFG_KEY,JSON.stringify(cfg)); }
function readGithubCfg(){
  const old=getGithubCfg();
  if(old.owner&&old.repo&&old.branch&&old.token) return old;
  const owner=prompt('GitHub Ownerï¼ˆç”¨æˆ·åï¼‰', old.owner||'jasonyangaccela'); if(owner===null) return null;
  const repo=prompt('GitHub Repoï¼ˆä»“åº“åï¼‰', old.repo||'timetable'); if(repo===null) return null;
  const branch=prompt('Branchï¼ˆåˆ†æ”¯ï¼‰', old.branch||'main'); if(branch===null) return null;
  const token=prompt('GitHub PATï¼ˆä»…é¦–æ¬¡è¾“å…¥ï¼Œåç»­è‡ªåŠ¨ä¿å­˜ï¼‰', old.token||''); if(!token) return null;
  const cfg={owner:owner.trim(),repo:repo.trim(),branch:branch.trim(),token:token.trim()};
  setGithubCfg(cfg);
  return cfg;
}
async function githubPutFile(cfg,path,content,message){
  const api=`https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path).replace(/%2F/g,'/')}`;
  let sha;
  const g=await fetch(`${api}?ref=${cfg.branch}`,{headers:{Authorization:`Bearer ${cfg.token}`,Accept:'application/vnd.github+json'}});
  if(g.ok){const j=await g.json(); sha=j.sha;}
  const body={message,content:btoa(unescape(encodeURIComponent(content))),branch:cfg.branch};
  if(sha) body.sha=sha;
  const r=await fetch(api,{method:'PUT',headers:{Authorization:`Bearer ${cfg.token}`,Accept:'application/vnd.github+json','Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok){const t=await r.text(); throw new Error(t.slice(0,200));}
}

function clearForm(){ $('entryId').value=''; $('entryForm').reset(); $('saveBtn').textContent='æ–°å¢'; $('day').value='å‘¨ä¸€'; $('type').value='è¯¾ç¨‹'; $('alarmOn').checked=true; }
function fillForm(it){ ['entryId','title','day','type','start','end','location','note'].forEach(k=>$(k).value=it[k]||''); $('alarmOn').checked = it.alarmOn!==false; $('saveBtn').textContent='ä¿å­˜ä¿®æ”¹'; applyEditorCollapsed(false); window.scrollTo({top:0,behavior:'smooth'}); }

function render(){
  const fd=$('filterDay').value;
  const view=sortList(list).filter(i=>fd==='å…¨éƒ¨'||i.day===fd);
  $('tbody').innerHTML=''; $('cardsGrid').innerHTML=''; $('empty').style.display=view.length?'none':'block'; $('countChip').textContent=`å…± ${view.length} æ¡`;

  for(const it of view){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.day}</td><td><span class="pill">${it.start} - ${it.end}</span></td><td style="font-size:20px">${typeIcons[it.type]||'ğŸ“Œ'}</td><td>${esc(it.title)}</td><td>${esc(it.type)}</td><td>${esc(it.location||'-')}</td><td>${esc(it.note||'-')}</td><td>${it.alarmOn===false?'å…³é—­':'å¼€å¯'}</td><td><div class="actions"><button class="btn-ghost" data-action="edit" data-id="${it.id}">ç¼–è¾‘</button><button class="btn-danger" data-action="delete" data-id="${it.id}">åˆ é™¤</button></div></td>`;
    $('tbody').appendChild(tr);
  }

  const days=fd==='å…¨éƒ¨'?dayOrder:[fd];
  for(const day of days){
    const items=view.filter(x=>x.day===day);
    const col=document.createElement('div'); col.className='day-col';
    col.innerHTML=`<h3>${day}<span class="muted">${items.length} æ¡</span></h3><div class="day-list">${items.length?items.map(it=>`<div class="tt-card"><div class="icon">${typeIcons[it.type]||'ğŸ“Œ'}</div><div class="title">${esc(it.title)}</div><div class="meta">${esc(it.start)} - ${esc(it.end)}</div><div class="meta">${esc(it.type)} Â· ${esc(it.location||'-')}</div><div class="meta">é—¹é“ƒï¼š${it.alarmOn===false?'å…³':'å¼€'}</div><div class="meta">${esc(it.note||'-')}</div><div class="card-actions"><button class="btn-ghost" data-action="edit" data-id="${it.id}">ç¼–è¾‘</button><button class="btn-danger" data-action="delete" data-id="${it.id}">åˆ é™¤</button></div></div>`).join(''):'<div class="muted">æš‚æ— è¯¾ç¨‹</div>'}</div>`;
    $('cardsGrid').appendChild(col);
  }
}

$('entryForm').addEventListener('submit',e=>{e.preventDefault(); const id=$('entryId').value.trim(); const it={id:id||uid(),title:$('title').value.trim(),day:$('day').value,type:$('type').value,start:$('start').value,end:$('end').value,location:$('location').value.trim(),note:$('note').value.trim(),alarmOn:$('alarmOn').checked};
if(!it.title||!it.start||!it.end) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); if(it.start>=it.end) return alert('ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´'); if(id){const i=list.findIndex(x=>x.id===id); if(i>-1) list[i]=it;} else list.push(it); persist(); clearForm(); render();});
$('resetBtn').addEventListener('click',clearForm); $('filterDay').addEventListener('change',render);

function onAction(e){const b=e.target.closest('button'); if(!b) return; const id=b.dataset.id,a=b.dataset.action,it=list.find(x=>x.id===id); if(!it) return; if(a==='edit') fillForm(it); if(a==='delete'){ if(!confirm(`ç¡®å®šåˆ é™¤ã€Œ${it.title}ã€å—ï¼Ÿ`)) return; list=list.filter(x=>x.id!==id); persist(); render(); }}
$('tbody').addEventListener('click',onAction); $('cardsGrid').addEventListener('click',onAction);

$('clearAllBtn').addEventListener('click',()=>{ if(!list.length) return; if(!confirm('ç¡®å®šæ¸…ç©ºå…¨éƒ¨å®‰æ’å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return; list=[]; persist(); clearForm(); render();});
$('copyPrevDayBtn').addEventListener('click',()=>{ const target=$('filterDay').value; if(target==='å…¨éƒ¨') return alert('è¯·å…ˆåœ¨ç­›é€‰é‡Œé€‰æ‹©ç›®æ ‡æ˜ŸæœŸ'); const prev=dayOrder[(dayOrder.indexOf(target)+6)%7]; const src=sortList(list).filter(x=>x.day===prev); if(!src.length) return alert(`${prev} æ²¡æœ‰å¯å¤åˆ¶çš„è¯¾ç¨‹`); const keys=new Set(list.filter(x=>x.day===target).map(x=>`${x.start}|${x.end}|${x.title}|${x.type}|${x.location||''}|${x.note||''}`)); let n=0; for(const s of src){const k=`${s.start}|${s.end}|${s.title}|${s.type}|${s.location||''}|${s.note||''}`; if(keys.has(k)) continue; list.push({...s,id:uid(),day:target}); keys.add(k); n++;} persist(); render(); alert(`å·²ä» ${prev} å¤åˆ¶åˆ° ${target}ï¼šæ–°å¢ ${n} æ¡`);});
$('toggleAlarmBtn').addEventListener('click',async()=>{ const next=!isAlarmEnabled(); if(next&&'Notification' in window&&Notification.permission==='default'){ try{await Notification.requestPermission();}catch{} } setAlarmEnabled(next); });

function syncViewMode(){ $('tableWrap').classList.toggle('hidden',viewMode==='card'); $('cardsWrap').classList.toggle('hidden',viewMode!=='card'); $('toggleViewBtn').textContent=viewMode==='card'?'åˆ‡æ¢åˆ°è¡¨æ ¼æ¨¡å¼':'åˆ‡æ¢åˆ°å¡ç‰‡æ¨¡å¼'; }
function toggle(){viewMode=viewMode==='table'?'card':'table'; syncViewMode();}
$('toggleViewBtn').addEventListener('click',toggle);

function rows(){return sortList(list).map(i=>[i.day,`${i.start} - ${i.end}`,i.title,i.type,i.location||'',i.note||''])}
function dl(content,name,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(a.href),500)}
$('exportCsvBtn').addEventListener('click',()=>{if(!list.length) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®'); const csv=[['æ˜ŸæœŸ','æ—¶é—´','äº‹é¡¹','ç±»å‹','åœ°ç‚¹','å¤‡æ³¨'],...rows()].map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\r\n'); dl('\uFEFF'+csv,'timetable.csv','text/csv;charset=utf-8;')});
$('exportExcelBtn').addEventListener('click',()=>{if(!list.length) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®'); const html=`<html><head><meta charset="UTF-8"></head><body><table border="1"><tr><th>æ˜ŸæœŸ</th><th>æ—¶é—´</th><th>äº‹é¡¹</th><th>ç±»å‹</th><th>åœ°ç‚¹</th><th>å¤‡æ³¨</th></tr>${rows().map(r=>`<tr>${r.map(c=>`<td>${esc(c)}</td>`).join('')}</tr>`).join('')}</table></body></html>`; dl('\uFEFF'+html,'timetable.xls','application/vnd.ms-excel;charset=utf-8;')});

function buildImage(){const fd=$('filterDay').value; const view=sortList(list).filter(i=>fd==='å…¨éƒ¨'||i.day===fd); const days=fd==='å…¨éƒ¨'?dayOrder:[fd]; const g=14,colW=178,hHead=30,hCard=210,gCard=8,top=92; const max=Math.max(1,...days.map(d=>view.filter(x=>x.day===d).length)); const contentH=g+hHead+g+max*hCard+Math.max(0,max-1)*gCard+g; const w=days.length*colW+(days.length+1)*g,h=top+contentH; const c=document.createElement('canvas'),dpr=Math.max(2,window.devicePixelRatio||1),x=c.getContext('2d'); c.width=w*dpr;c.height=h*dpr;x.scale(dpr,dpr);
const rr=(a,b,cw,ch,r)=>{x.beginPath();x.moveTo(a+r,b);x.arcTo(a+cw,b,a+cw,b+ch,r);x.arcTo(a+cw,b+ch,a,b+ch,r);x.arcTo(a,b+ch,a,b,r);x.arcTo(a,b,a+cw,b,r);x.closePath()};
let bg=x.createLinearGradient(0,0,w,h); bg.addColorStop(0,'#1a2452'); bg.addColorStop(1,'#3b1f66'); x.fillStyle=bg; x.fillRect(0,0,w,h); x.fillStyle='#fff'; x.font='700 28px Segoe UI,Microsoft YaHei'; x.fillText('ğŸ“… Time Table',18,38); x.font='500 14px Segoe UI,Microsoft YaHei'; x.fillText(fd==='å…¨éƒ¨'?`å…¨éƒ¨å®‰æ’ Â· å…± ${view.length} æ¡`:`${fd} Â· å…± ${view.length} æ¡`,18,62);
days.forEach((day,di)=>{const its=view.filter(v=>v.day===day),cx=g+di*(colW+g),cy=top+g; x.fillStyle='rgba(255,255,255,.1)'; rr(cx,cy,colW,contentH-g*2,12); x.fill(); x.strokeStyle='rgba(255,255,255,.18)'; x.stroke(); x.fillStyle='#fff'; x.font='700 14px Segoe UI,Microsoft YaHei'; x.fillText(day,cx+10,cy+20); x.fillStyle='rgba(255,255,255,.72)'; x.font='500 11px Segoe UI'; x.fillText(`${its.length} æ¡`,cx+colW-34,cy+20);
if(!its.length){x.fillText('æš‚æ— è¯¾ç¨‹',cx+10,cy+50); return;} its.forEach((it,i)=>{const xx=cx+8,yy=cy+hHead+g+i*(hCard+gCard),ww=colW-16; x.fillStyle='rgba(255,255,255,.14)'; rr(xx,yy,ww,hCard,12); x.fill(); x.strokeStyle='rgba(255,255,255,.2)'; x.stroke(); x.fillStyle='#fff'; x.font='34px Segoe UI Emoji'; x.fillText(typeIcons[it.type]||'ğŸ“Œ',xx+8,yy+40); x.font='700 15px Segoe UI,Microsoft YaHei'; x.fillText((it.title||'').slice(0,10),xx+8,yy+66); x.font='500 12px Segoe UI,Microsoft YaHei'; x.fillText(`${it.start} - ${it.end}`,xx+8,yy+88); x.fillText(`${it.type} Â· ${(it.location||'-').slice(0,12)}`,xx+8,yy+110); x.fillStyle='rgba(255,255,255,.72)'; x.fillText(`å¤‡æ³¨ï¼š${(it.note||'-').slice(0,12)}`,xx+8,yy+132);});});
return c;}

$('exportImageBtn').addEventListener('click',()=>{if(!list.length) return alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®'); const c=buildImage(); const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='timetable.png'; a.click();});
$('shareImageBtn').addEventListener('click',async()=>{if(!list.length) return alert('æ²¡æœ‰å¯åˆ†äº«çš„æ•°æ®'); if(!navigator.share) return alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥åˆ†äº«ï¼Œè¯·å…ˆå¯¼å‡ºå›¾ç‰‡å†å‘å¾®ä¿¡ã€‚'); const c=buildImage(); const blob=await new Promise(r=>c.toBlob(r,'image/png')); if(!blob) return; const file=new File([blob],'timetable.png',{type:'image/png'}); try{ if(navigator.canShare && !navigator.canShare({files:[file]})) throw new Error(); await navigator.share({files:[file],title:'è¯¾ç¨‹è¡¨'});}catch(e){ if(e.name!=='AbortError') alert('å½“å‰ç¯å¢ƒä¸èƒ½ç›´æ¥æ‹‰èµ·å¾®ä¿¡åˆ†äº«ï¼Œè¯·å¯¼å‡ºå›¾ç‰‡åå‘é€ã€‚'); }});

$('backupGithubBtn').addEventListener('click',async()=>{
  if(!list.length) return alert('å½“å‰æ²¡æœ‰å¯å¤‡ä»½çš„æ•°æ®');
  const cfg=readGithubCfg(); if(!cfg) return;
  const now=new Date();
  const stamp=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
  const payload=JSON.stringify(list,null,2);
  try{
    await githubPutFile(cfg,`backups/timetable-${stamp}.json`,payload,`backup: ${stamp}`);
    await githubPutFile(cfg,'backups/latest.json',payload,`backup latest: ${stamp}`);
    await githubPutFile(cfg,'data.json',payload,`publish data: ${stamp}`);
    alert('å¤‡ä»½æˆåŠŸï¼šå·²å†™å…¥ backups/latest.json å’Œå¸¦æ—¶é—´æˆ³å¤‡ä»½');
  }catch(e){ alert('å¤‡ä»½å¤±è´¥ï¼š'+(e.message||e)); }
});

$('restoreGithubBtn').addEventListener('click',async()=>{
  const cfg=readGithubCfg(); if(!cfg) return;
  const url=`https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/${cfg.branch}/backups/latest.json?v=${Date.now()}`;
  try{
    const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('æœªæ‰¾åˆ° latest.json');
    const d=await r.json(); if(!Array.isArray(d)) throw new Error('å¤‡ä»½æ ¼å¼ä¸æ­£ç¡®');
    if(!confirm(`å°†è¦†ç›–æœ¬åœ°æ•°æ®ï¼Œå…± ${d.length} æ¡ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`)) return;
    list=d; persist(); render();
    alert('æ¢å¤æˆåŠŸï¼šå·²ä» GitHub latest å¤‡ä»½æ¢å¤');
  }catch(e){ alert('æ¢å¤å¤±è´¥ï¼š'+(e.message||e)); }
});

$('forceRefreshBtn').addEventListener('click',async()=>{try{if('serviceWorker'in navigator){const rs=await navigator.serviceWorker.getRegistrations(); await Promise.all(rs.map(r=>r.unregister()));} if('caches'in window){const ks=await caches.keys(); await Promise.all(ks.map(k=>caches.delete(k)));} alert('å·²æ¸…ç†ç¼“å­˜ï¼Œæ­£åœ¨å¼ºåˆ¶æ›´æ–°â€¦'); location.href=`${location.pathname}?v=${Date.now()}`;}catch{location.reload(true)}});

function applyEditorCollapsed(collapsed){
  document.body.classList.toggle('collapsed-editor', !!collapsed);
  $('toggleEditorBtn').textContent = collapsed ? 'å±•å¼€ç¼–è¾‘' : 'æ”¶èµ·ç¼–è¾‘';
  localStorage.setItem(EDITOR_COLLAPSED_KEY, collapsed ? '1' : '0');
}
$('toggleEditorBtn').addEventListener('click',()=>{
  const collapsed = !document.body.classList.contains('collapsed-editor');
  applyEditorCollapsed(collapsed);
});

$('day').value='å‘¨ä¸€'; $('type').value='è¯¾ç¨‹';
const collapsedSaved=localStorage.getItem(EDITOR_COLLAPSED_KEY);
const defaultCollapsed = window.matchMedia('(max-width: 980px)').matches;
applyEditorCollapsed(collapsedSaved===null ? defaultCollapsed : collapsedSaved==='1');
syncViewMode();
updateAlarmUI();
setInterval(alarmTick,30000);
(async()=>{await hydrateFromPublishedData(); render(); alarmTick();})();
if('serviceWorker'in navigator) window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(()=>{}));
</script>
</body></html>